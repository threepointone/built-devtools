{"version":3,"file":"AccessibilityTreeUtils.js","sourceRoot":"","sources":["../../../../../../front_end/panels/elements/AccessibilityTreeUtils.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as TreeOutline from '../../ui/components/tree_outline/tree_outline.js';\nimport * as ElementsComponents from './components/components.js';\nimport * as LitHtml from '../../ui/lit-html/lit-html.js';\n\nexport type AXTreeNodeData = SDK.AccessibilityModel.AccessibilityNode;\nexport type AXTreeNode = TreeOutline.TreeOutlineUtils.TreeNode<AXTreeNodeData>;\n\nexport function sdkNodeToAXTreeNode(sdkNode: SDK.AccessibilityModel.AccessibilityNode): AXTreeNode {\n  const treeNodeData = sdkNode;\n  const role = sdkNode.role()?.value;\n\n  if (role === 'Iframe') {\n    return {\n      treeNodeData,\n      children: async(): Promise<AXTreeNode[]> => {\n        const domNode = await sdkNode.deferredDOMNode()?.resolvePromise();\n        if (!domNode) {\n          throw new Error('Could not find corresponding DOMNode');\n        }\n        const frameId = domNode.frameOwnerFrameId();\n\n        let document = domNode.contentDocument();\n        if (!document && frameId) {\n          const frame = SDK.FrameManager.FrameManager.instance().getFrame(frameId);\n          if (!frame) {\n            return [];\n          }\n          document = await frame.resourceTreeModel().domModel().requestDocument();\n        }\n        if (!document) {\n          return [];\n        }\n\n        const axmodel = document.domModel().target().model(SDK.AccessibilityModel.AccessibilityModel);\n        if (!axmodel) {\n          throw new Error('Could not find AccessibilityModel for child document');\n        }\n        // Check if we have requested the node before:\n        let localRoot = axmodel.axNodeForDOMNode(document);\n        if (!localRoot && frameId) {\n          // Request the root node of the iframe document:\n          localRoot = await axmodel.requestRootNode(1, frameId) || null;\n        }\n        if (!localRoot) {\n          throw new Error('Could not find root node');\n        }\n        return [sdkNodeToAXTreeNode(localRoot)];\n      },\n      id: sdkNode.id(),\n    };\n  }\n\n  if (!sdkNode.numChildren()) {\n    return {\n      treeNodeData,\n      id: sdkNode.id(),\n    };\n  }\n\n  return {\n    treeNodeData,\n    children: async(): Promise<AXTreeNode[]> => {\n      if (sdkNode.numChildren() === sdkNode.children().length) {\n        return sdkNode.children().map(child => sdkNodeToAXTreeNode(child));\n      }\n      // numChildren returns the number of children that this node has, whereas node.children()\n      // returns only children that have been loaded. If these two don't match, that means that\n      // there are backend children that need to be loaded into the model, so request them now.\n      await sdkNode.accessibilityModel().requestAXChildren(sdkNode.id(), sdkNode.getFrameId() || undefined);\n\n      if (sdkNode.numChildren() !== sdkNode.children().length) {\n        throw new Error('Once loaded, number of children and length of children must match.');\n      }\n\n      const treeNodeChildren: AXTreeNode[] = [];\n\n      for (const child of sdkNode.children()) {\n        treeNodeChildren.push(sdkNodeToAXTreeNode(child));\n      }\n\n      return treeNodeChildren;\n    },\n    id: sdkNode.id(),\n  };\n}\n\ntype Data = ElementsComponents.AccessibilityTreeNode.AccessibilityTreeNodeData;\n\nexport function accessibilityNodeRenderer(node: AXTreeNode): LitHtml.TemplateResult {\n  const tag = ElementsComponents.AccessibilityTreeNode.AccessibilityTreeNode.litTagName;\n  const sdkNode = node.treeNodeData;\n  const name = sdkNode.name()?.value || '';\n  const role = sdkNode.role()?.value || '';\n  const ignored = sdkNode.ignored();\n  return LitHtml.html`<${tag} .data=${{name, role, ignored} as Data}></${tag}>`;\n}\n"]}